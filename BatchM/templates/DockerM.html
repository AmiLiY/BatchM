{% extends "index.html" %}
{% load custom_tag %}
{% block stitle %}
    docker管理
{% endblock %}
{% block btitle %}
    <span id="btitle">{{ big_title }}</span>
{% endblock %}
{% block page_content %}

<!-- 下面的div-form是在创建容器的时候输入的创建参数，比如CPU，端口映射等 -->
<div style="display:none" id="create_container_div">
    <form id='create_container_form' class="form-horizontal" role="form" action="{% url 'docker_containers_manage' %}" method="get">
            <div class="form-group">
                <label for="host_image" class="col-sm-3 control-label">宿主机与镜像</label>
                    <div class="col-xs-7">
                        <select id="host_image" name='host_image' class="form-control">
                            {% for image in images %}
                                <option>{{ image.Host_ip.select_related.first }}&nbsp;{{ image.Repo_tags }}</option>
                            {% endfor %}
                        </select>
                    </div>
            </div>
            <div class="form-group">
                <label for="name" class="col-sm-3 control-label">容器名字</label>
                <div class="col-xs-7">
                    <input type="text" name="name" class="form-control" id="name" placeholder="容器名字 -- 必填项">
                </div>
            </div>
            <div class="form-group">
                <label for="command" class="col-sm-3 control-label">命令</label>
                <div class="col-xs-7">
                    <input type="text" name='command' class="form-control" id="command" placeholder="命令">
                </div>
            </div>

            <!-- <div class="form-group">
                <label for="startup" class="col-sm-3 control-label">创建后是否启动</label>
                <div class="col-xs-7">
                    <span>启动</span>
                    <input type="radio" name='startup'  id="startup" value="True" checked="checked" >&nbsp;&nbsp;&nbsp;
                    <span>不启动</span>
                    <input type="radio" name='startup' id="startup" value="False" >
                </div>
            </div> -->
            <div class="form-group">
                <label for="" class="col-sm-3 control-label">其他高级配置</label>
                    <div class="col-xs-7">
                       <input id='showMoreConfig' type="checkbox" />
                    </div>
            </div>
            <div id="complex_config" style="display: none;">
                &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:red;font-size: larger">以下输入框为空，那么就按docker默认配置创建</span>
                <div class="form-group">
                    <label for="cpu_group " class="col-sm-3 control-label">cpu_group</label>
                        <div class="col-xs-7">
                           <input type="text" name="cpu_group " class="form-control" id="cpu_group" placeholder="CPU时间分片的长度(毫秒),如50000">
                        </div>
                </div>
                <div class="form-group">
                    <label for="cpu_period " class="col-sm-3 control-label">cpu_period</label>
                        <div class="col-xs-7">
                           <input type="text" name='cpu_period ' class="form-control" id="cpu_period" placeholder="容器可获得CPU时间分片的量(毫秒),如100000">
                        </div>
                </div>
                <div class="form-group">
                    <label for="cpu_shares " class="col-sm-3 control-label">cpu_shares</label>
                        <div class="col-xs-7">
                           <input type="text" name="cpu_shares " class="form-control" id="cpu_shares " placeholder="对比其他容器占用CPU的相对权重,如512">
                        </div>
                </div>
                <div class="form-group">
                    <label for="mem_limit " class="col-sm-3 control-label">mem_limit </label>
                        <div class="col-xs-7">
                           <input type="text" name='mem_limit ' class="form-control" id="mem_limit " placeholder="内存使用限制,输入数字和单位,如1G">
                        </div>
                </div>
                <div class="form-group">
                    <label for="dns" class="col-sm-3 control-label">DNS 设置</label>
                        <div class="col-xs-7">
                           <input type="text" name='dns' class="form-control" id="dns" placeholder="设置容器DNS,多个IP用逗号相隔">
                        </div>
                </div>
                <div class="form-group">
                    <label for="network_mode  " class="col-sm-3 control-label">network_mode </label>
                        <div class="col-xs-7">
                            <select id="network_mode " namne="network_mode ">
                                <option selected="selected"></option>
                                <option>bridge</option>
                                <option>host</option>
                                <option>none</option>
                            </select>
                        </div>
                </div>
                <div class="form-group">
                    <label for="hostname" class="col-sm-3 control-label">hostname</label>
                    <div class="col-xs-7">
                       <input type="text" name='hostname' class="form-control" id="hostname" placeholder="设置容器hostname">
                    </div>
                </div>
                <div class="form-group">
                    <label for="ports" class="col-sm-3 control-label">端口映射</label>

                    <span  onmouseover="$(this).popover('toggle')"  onmouseout="$(this).popover('toggle')"
                        data-container="body" data-toggle="popover" data-placement="right"
                       data-content="The port number, as an integer. For example,
                       1. {'2222/tcp': 3333} will expose port 2222 inside the container as port 3333 on the host.
                       2.None, to assign a random host port. For example:{'2222/tcp': None}.
                       3. A tuple of (address, port) if you want to specify the host interface. For example,{'1111/tcp': ('127.0.0.1', 1111)}.
                       4. A list of integers, if you want to bind multiple host ports to a single container port. For example,{'1111/tcp': [1234, 4567]}.">？
                    </span>
                    <div class="col-xs-7">
                       <input type="text" name='ports' class="form-control" id="ports" placeholder="设置容器与宿主机之间的端口映射">
                    </div>
                </div>

                <div class="form-group">
                    <label for="volumes" class="col-sm-3 control-label">目录映射</label>

                    <span  onmouseover="$(this).popover('toggle')"  onmouseout="$(this).popover('toggle')"
                       data-container="body" data-toggle="popover" data-placement="right"
                       data-content="挂载目录的方式：{'宿主机目录':{'bind':'容器内目录','mode':’rw‘}}
                        {'/home/user1/': {'bind': '/mnt/vol2', 'mode': 'rw'},
                        '/var/www': {'bind': '/mnt/vol1', 'mode': 'ro'}}">？
                    </span>
                    <div class="col-xs-7">
                       <input type="text" name='volumes' class="form-control" id="volumes" placeholder="设置容器与宿主机之间文件系统的挂载">
                    </div>
                </div>
            </div>
        </form>
</div>

<!-- 下面的代码是显示按钮的，在填写完创建容器的信息后，需要点击创建按钮才能创建，或者其他的操作 -->
<div id="create_container_button" style="display: none">
    <button type="button" class="btn btn-info" id='save_model' onclick="create_container(this)">保存为模板</button>
    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
    <button type="button" class="btn btn-primary" id='create_container' onclick="create_container(this)">创建容器</button>
</div>

<!-- 下面的代码是在对容器执行命令的时候显示的  -->
<div style="display:none" id="enter_cmd_div">
    <form id='enter_cmd_form' class="form-horizontal" role="form" >
            <div class="form-group">
                <label for="exec_cmd" class="col-sm-3 control-label">输入命令</label>
                    <div class="col-xs-7">
                        <input id="exec_cmd_input" name='exec_cmd_input' class="form-control" placeholder="请填写需要执行的命令">
                    </div>
            </div>
    </form>
</div>

<!-- 下面的代码是显示按钮的，在填写完要对容器执行的命令信息后供用户选择 -->
<div id="enter_cmd_button" style="display: none">
    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
    <button type="button" class="btn btn-primary" id='exec_cmd' onclick="start_containers(this)">执行命令</button>
</div>

<!-- 下面这这些代码是在点击创建容器信息或者对容器执行命令以后展现出来的 -->
<div class="modal fade " id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel2">请注意</h4>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>


<div id="Dmanage">
    <div class="row">
            <div type="button" class="col-xs-2 col-sm-2"><input type="button" class="btn btn-success"  value="创建一个新容器" onclick="show_create_table()" ></div>
            <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-danger" id="remove_containers" value="销毁选中的容器" onclick="start_containers(this)"></div>
            <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-warning" id="show_exec_cmd_from" value="发送命令到指定容器" onclick="show_entercmd_table()"></div>
            <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info"   id="show_process" value="查看容器进程"  onclick="start_containers(this)"></div>
            <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info" id="start_containers" value="启动指定容器" onclick="start_containers(this)"></div>
            <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info" id="stop_containers" value="停止指定容器" onclick="start_containers(this)"></div>
    </div><br>
    <form class="form-horizontal" role="form">
        <div class="form-group">


            <div class="col-sm-3">
              <input class="btn" style="float: left;" value="搜索容器" type="button" onclick="search_container(this)">
              <input  name="container_search" type="text"  style="width: 65%" class="form-control" id="container_search" placeholder="输入容器ID或者名字">
            </div><div>
                <label style="font-size: large; bottom: 10%" >切换主机</label>
              <select id="switch_host" style="width: 15%" name="switch_host" onclick="switch_hosts()">
                    <option selected="selected">所有主机</option>
                    {% for host in hosts %}
                        <option>{{ host.host_ip }}</option>
                    {% endfor %}
              </select>&nbsp;&nbsp;&nbsp;
                <input value="全选" type="button" name="select_all" id="select_all" onclick='select_all_containers()' >
                <input value="反选" type="button" name="reverse_all" id="reverse_all" onclick='reverse_all_containers()'>
                <input value="取消" type="button" name="cancel_all" id="cancel_all"  onclick='cancel_all_containers()'>
                <button type="button" id="myButton" data-loading-text="Loading..." class="btn btn-primary" autocomplete="off"  onclick='fresh_all_containers()'>
                    刷新
                </button>
            </div>
        </div>
    </form>

    <table class="table table-hover">
        <tr id="first_tr">
            <td>选中</td>
            <td>宿主机IP端口</td>
            <td>容器ID</td>
            <td>容器名字</td>
            <td>容器镜像</td>
            <td>运行的命令</td>
            <td>创建时间</td>
            <td>运行状态</td>
            <td>数据更新时间</td>
        </tr>
        {% for docker in docker_containers %}
            <tr class="show_line">
                <td><input type="checkbox" host_port="{{ docker.Real_host_ip }}" name="{{ Container_id }}" value="{{ docker.Container_id }}"></td>
                <td><a class="real_host_ip" href="/BatchM/DockerM/{{ docker.Real_host_ip }}">{{ docker.Real_host_ip }}&nbsp;</a></td>
                <td><a href="/BatchM/DockerM.html/{{ docker.Container_id }}" class="container_id">{{ docker.Container_id | docker_short_id }}</a></td>
                <td>{{ docker.Container_name }}</td>
                <td>{{ docker.Container_image }}</td>
                <td>{{ docker.Command }}</td>
                <td>{{ docker.Created }}</td>
                <td>{{ docker.Status }}</td>
                <td>{{ docker.Record_time }}</td>
            </tr>
        {% endfor %}
    </table>

</div>


<div id="Dimages">
    <div class="row">
        <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info"   id="ShowImages" value="刷新镜像信息" onclick="manage_images(this)"></div>
        <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info"   id="delete_images" value="删除选中镜像" onclick="manage_images(this)"></div>
        <div class="col-xs-2 col-sm-2"><input type="button" class="btn btn-info"   id="add_image" value="上传镜像" onclick="manage_images(this)"></div>
    </div></br>

    <form class="form-horizontal" role="form">
        <div class="form-group">
              <input value="全选" type="button" name="select_all" id="select_all" onclick='select_all_containers()' >
              <input value="反选" type="button" name="reverse_all" id="reverse_all" onclick='reverse_all_containers()'>
              <input value="取消" type="button" name="cancel_all" id="cancel_all"  onclick='cancel_all_containers()'>
            <div class="col-sm-3">
              <input class="btn" style="float: left;" value="搜索镜像" type="button" onclick="search_container(this)">
              <input  name="container_search" type="text"  style="width: 65%" class="form-control" id="images_search"  placeholder="输入容器ID或者tag">
            </div>
    </form>
    <table class="table table-hover">
        <tr id="second_tr">
            <td>选中</td>
            <td>宿主机IP端口</td>
            <td>镜像ID</td>
            <td>仓库备注</td>
            <td>仓库摘要</td>
            <td>创建时间</td>
            <td>镜像实际大小</td>
            <td>镜像虚拟大小</td>
            <td>标签</td>
            <td>数据更新时间</td>
        </tr>
        {% for image in docker_images %}
            <tr class="show_line">
                <td><input type="checkbox" host_port="{{ image.Host_ip.select_related.first }}" name="{{ image.Image_id }}" value="{{ image.Image_id }}"></td>
                <td><a class="Host_ip" href="/BatchM/DockerM.html/{{ image.Host_ip.select_related.first }}">{{ image.Host_ip.select_related.first }}&nbsp;</a></td>
                <td><a href="/BatchM/DockerM.html/{{ image.Image_id }}" class="container_id">{{ image.Image_id | docker_short_id }}</a></td>
                <td>{{ image.Repo_tags }}</td>
                <td>{{ image.Repo_digests }}</td>
                <td>{{ image.Created }}</td>
                <td>{{ image.Image_size }}</td>
                <td>{{ image.Virtual_size }}</td>
                <td>{{ image.Labels }}</td>
                <td>{{ image.update_time }}</td>
            </tr>
        {% endfor %}
    </table>
</div>

{% endblock %}

{% block encoding_js %}
    <script>

    $(document).ready( function () {    // 这个方法来用去高亮当前页面到右边选择到标签
                if ($('#btitle').text() == 'Docker 容器管理') {
                    $('#docker_manage').toggleClass('active').siblings().removeClass('active');
                    $('#sub-item-2').addClass('in').removeAttr('style');
                    $('#containers_manage').css('background-color','grey');
                    $('#Dimages').hide();
                    $('#Dmanage').show();
                } else if($('#btitle').text() == 'Docker镜像查看') {
                    $('#Dmanage').attr('style','display:none');
                    $('#docker_manage').toggleClass('active').siblings().removeClass('active');
                    $('#sub-item-2').addClass('in').removeAttr('style');
                    $('#images_show').css('background-color','grey');
                    $('#Dmanage').hide();
                    $('#Dimages').show();
                } // end if
                $('input :checkbox').prop('checked',false);

            } // end function
        ); // end ready

    function switch_hosts() {   // 根据下拉框来切换容器显示列表
        var select_host = $('#switch_host').val();
        for(var host_ip in $('.real_host_ip').text().splice){
{#            if(select_host != host_ip){#}
                console.log()

        }//end for
    }

    function select_all_containers() {    // 全选，选中所有容器
        $('input:checkbox').prop('checked',true);
    }

    function reverse_all_containers() {   // 反选, 反选所有容器
        $('input:checkbox').each(function () {
            if (!$(this).prop('checked')) {
                $(this).prop('checked', true)
            }else{
                 $(this).prop('checked', false)
            }
        })
    }


    function cancel_all_containers() {   // 取消选择
        $('input:checkbox').prop('checked',false);
    }


    // 把手动刷新的内容加载到显示表格里
    function show_all_containers(arg) {
            $('#exec_status').remove();
            $('.show_line').remove();

            $.each($('#first_tr').children('td'),function () {    // 在执行玩完查看容器的进程信息后，需要把表格标题还原回去
                // 还原到第一步就是先删除原来有到标题，在插入新到标题
                if($(this).index() >3 ){
                    $(this).remove()
                }
            });
            var td_code = "<td>容器镜像</td><td>运行的命令</td><td>创建时间</td><td>运行状态</td><td>数据更新时间</td>";
            $('#first_tr').append(td_code);  // 插入新到标题

            var disconnect_hosts = arg.disconnect_hosts;
            if( disconnect_hosts != undefined ){
                for (var i in disconnect_hosts){
                    var html_code = '<tr class="show_line"><td><input type="checkbox"></td><td>服务器 <span style="color:red">'
                            +disconnect_hosts[i] +' </span>链接不上</td> </tr>';
                    $('#first_tr').after(html_code);
                }
            };
            for (var info in arg) {
                var container_info = arg[info];
                if (info != 'disconnect_hosts'){
                    var html_code = ' <tr class="show_line"><td><input host_port="'+ container_info.Real_host_ip+'" type="checkbox" name="' + container_info.Container_id + '" value="' + container_info.Container_id + '"></td> ' +
                            '<td><a class="real_host_ip" href="/BatchM/DockerM.html/' + container_info.Real_host_ip + '">' + container_info.Real_host_ip + '&nbsp;</a></td> ' +
                            '<td><a href="/BatchM/DockerM.html/' + container_info.Container_id + '"class="container_id">' + container_info.Container_id.substring(0, 12) + '</a></td>' +
                            '<td>' + container_info.Container_name + '</td>' +
                            '<td>' + container_info.Container_image + '</td>' +
                            '<td>' + container_info.Command + '</td> ' +
                            '<td>' + container_info.Created + '</td> ' +
                            '<td>' + container_info.Status + '</td> ' +
                            '<td>' + container_info.Record_time + '</td><tr>';
                    $('#first_tr').after(html_code);
                } // end if
            }
        }


    // 刷新当前容器信息
    function fresh_all_containers() {
        $('#myButton').button('loading');
        // business logic...
        $.ajax({
            url: "{%  url 'all_containers_info' %}",
            type:'post',
            dataType:'json',
            token:csrftoken,
            data:{'refresh':"True",'action':'select',"type":'containers'},
            success:function (callback) {
                show_all_containers(callback);
                $('#myButton').button('reset');
            }, //end success
            error:function (callback) {
                alert('刷新失败  ',callback);
{#                show_all_containers(callback);#}
                $('#myButton').button('reset')
                }
            });
        }

    // 搜索容器的
    function search_container(arg) {
        var action_type = $(arg).val();
        console.log(action_type);
        if (action_type == "搜索容器"){
            var container_name = $('#container_search').val().trim();
            var get_url = '{% url "all_containers_info" %}'

        } else if(action_type == "搜索镜像") {
            var container_name = $('#images_search').val().trim();
            var get_url = '{% url "all_images_info" %}'
        }
        console.log(get_url,container_name);
        $.ajax({
            url: get_url,
            type: 'get',
            dataType:'json',
            token:csrftoken,
            data:{'container_info':container_name},
            success: function (callback) {
                    console.log(callback);
                    if(action_type == "搜索容器"){show_all_containers(callback)}
                    else if(action_type == "搜索镜像"){show_new_images(callback)}

            },//end success
            error:function (callback) {
                alert('查找失败,请确保名字或ID正确  ',callback);
            } //end err
        }); // end ajax
        }


    // 更改模态框内容的
    function show_madel(arg,mode) {
        if (mode == "ALERT"){
            alert(arg)   // 弹出警告，没有选中任何机器
            $('#myModal').modal('toggle');   // 清除模态框
        }else{
            $('#myModal').modal('toggle');
            $('.modal-body').html(arg);
        }
    }


    // 显示对容器操作的执行状态
    function show_exec_status(trid,arg) {
        // console.log('show_exec_status',arg);
        var exec_succ = "<td><span style='background-color:lightgreen'>执行成功</td>";  // 定义文本执行成功到内容
        var exec_err = "<td><span style='background-color:orange'>执行失败</td>";  // 定义文本执行失败到内容
        var space_place = "<td></td>";
        var success_list = arg.success[0];
        console.log(success_list,'success_list');
        $('#exec_status').remove();   // 删除这个状态栏,避免后面重复叠加l
        $('#'+trid).append("<td id='exec_status'>执行状态</td>");  // 每行末尾添加一个显示执行状态到列

        if (trid == 'first_tr'){
             var error_list = arg.error;   // 这里到error列表返回来到事容器ID，容器ID是独一无二的，所以只需要匹配容器ID就可以了。
            $.each($('input:checkbox'),function(){   // 获取所有选中到的input 的标签
                //if($(this).prop('checked') == true){    // 因为点击操作容器按钮后会出现弹框，所有用户没有足够到时间来做反选，全选到动作，
                    // 所以不许要判断全部复选框，只需要判断选中的复选框就行来。
                    for(var i in success_list){
                           // console.log('succes',i);
                            var ci = i.substring(0,12);
                            var container_id = $(this).parent('td').siblings().children('.container_id').text().trim();
                            if(ci == container_id) {
                                $(this).parents('td').parent().append(exec_succ);   //显示这次到执行状态
                            }
                    } // end for

                   for (var i in error_list){
                      // console.log('error',error_list[i]);
                       var ci = error_list[i].substring(0,12);
                       var container_id = $(this).parent('td').siblings().children('.container_id').text().trim();
                        if(ci == container_id) {
                            $(this).parents('td').parent().append(exec_err); //显示这次到执行状态
                        } // end if
                    } // end for
                }); // end each
        }else if(trid == 'second_tr'){    // 需要判断所有到复选框，因为不会出现弹框，所以用户有足够到时间来做全选反选动作。
             var error_list = arg.error[0];    // 后台返回来到数据是宿主机IP和镜像ID，根据宿主机IP和镜像ID同时在html页面匹配后显示执行状态
             $.each($('input:checkbox'),function(){
                 var image_host_id = $(this).attr('host_port') + $(this).val();
                 console.log('image_host_id',image_host_id);
                 for(var err in error_list){
                    console.log('hehe',error_list[err],err);
                     var return_host_id = err+error_list[err];
                     if(image_host_id==return_host_id){
                         /**if($(this).parent().siblings().length > 9){   // 通过标签个数来判断是否添加来状态提醒
                                    $(this).parent().siblings().last().remove();  // 删除上一次到执行状态
                                } **/
                         $(this).parents('td').parent().append(exec_err)

                     }
                 }// end for
                 for (var succ in success_list){
                     console.log('succ',succ,success_list[succ]);
                     var return_host_id = succ+success_list[succ];
                      if(image_host_id==return_host_id){
                         $(this).parents('td').parent().append(exec_succ)
                     }
                 }
             }); // end each
        }}


    // 显示容器内部进程信息的
    function show_container_process(arg) {
        //var success_list = arg.success;
        //var error_list = arg.error;
        // 首先把原来到标题给清空掉
        $.each($('#first_tr').children('td'),function () {
            if ($(this).index() > 3 ){
                $(this).remove()
            }
        });
        var html_code = "<td>用户</td><td>CPU占用率</td><td>内存占用率</td><td>进程状态</td><td>进程启动时间</td><td>执行的命令</td>";
        $('#first_tr').append(html_code);
        console.log(arg);
        var success_list = arg.success[0];   // 提取获取进程信息成功列表
        var error_list = arg.error;   //  获取进程信息失败到列表
        for (var container_processes in success_list){   // 遍历进程信息成功列表
            $.each($('.show_line'),function()  {
                $(this).append('<td></td>');   // 在每一行添加一个td标签
                var input_checkbox = $(this).children('td').children('input:checkbox').val();
                // 进行匹配容器ID，匹配到位后提取该容器信息到值
                if( input_checkbox == container_processes ){
                    var processes = success_list[container_processes].Processes;   // 把进程信息的列表信息提取出来
                    $.each($(this).children('td'),function (){    // 清空当前行的td栏的内容
                        if($(this).index() > 3 ) {
                            $(this).empty()
                        }
                    });
                    for (var i in processes){    // 遍历每一个进程信息
                        var each_process = processes[i];
                        var user = each_process[0];
                        var CPUusage = each_process[2];
                        var MemUsage = each_process[3];
                        var ProStatus = each_process[7];
                        var StartTime = each_process[8];
                        var Command = each_process[10];
                        // 遍历每一行内容的td标签,匹配到index相等到值就把上面这些获取到进程信息塞入进去
                        $.each($(this).children('td'),function () {
                           if($(this).index() == 4){
                                $(this).append(user+',<br>')
                           }else if($(this).index() == 5){
                                $(this).append(CPUusage+',<br>')
                           }else if($(this).index() == 6){
                                $(this).append(MemUsage+',<br>')
                           }else if($(this).index() == 7){
                                $(this).append(ProStatus+',<br>')
                           }else if($(this).index() == 8){
                                $(this).append(StartTime+',<br>')
                           }else if($(this).index() == 9){
                                $(this).append(Command+',<br>')
                           }

                        });// end each
                    }// end for
                } // end if
            }) // end each
        }
        for(var error_container in error_list){
            var err = error_list[error_container];
            $.each($('.show_line'),function()  {   // 遍历tr/td标签，匹配到容器ID后打上标签

                var input_checkbox = $(this).children('td').children('input:checkbox').val();
                // 进行匹配容器ID，匹配到位后提取该容器信息到值
                if( input_checkbox == err ) {
                    $.each($(this).children('td'),function (){    // 清空当前行的td栏的内容
                        if($(this).index() > 3 ) {
                            $(this).empty()
                        }
                    });
                    $.each($(this).children('td'), function () {
                        if ($(this).index() == 4) {
                            $(this).append('<span style="background-color: orange;">容器链接没有运行或者已经死亡' +
                                    ',  检索不到任何进程信息</span>')
                        }// end if
                    });// end each
                }
            })
        }
    }

    // 启动和停止指定的容器
    function start_containers(arg) {
        var container_id_array = {};
        var action_type = $(arg).attr('id');     // 获取操作按钮的类型，通过这个来判断做什么动作
        var cmd = '';   //定义这个变量，避免ajax提交的时候后面出错
        $.each($('.table input:checkbox'),function(){   // 获取所有选中到的input 的标签
            if($(this).prop('checked') == true){
                container_id_array[($(this).val())] = $(this).attr('host_port');  // 做成一个字典,以容器ID为key，宿主机IP为value
            }// end if
        });
        var close_button = '<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>';  // 在弹下来的模态框做一个close按钮.
        $('.modal-footer').html(close_button);
        var lenarray = len_of_dict(container_id_array);
        console.log('lenarray',lenarray,container_id_array);
        if ( lenarray == 0){   // 判断是否选中来某一个容器
            var return_body= "您没有选中一个容器！！！<br>您没有选中一个容器！！！<br>您没有选中一个容器！！！重要事情说三遍";
            if (action_type == "exec_cmd" ) {
                show_madel(return_body,'ALERT');
            }else{
                show_madel(return_body);
            }

            return false
        }


        if(action_type=="stop_containers"){
            var action = "stop";
            var type = 'containers';
            var button_text = $('#stop_containers').val();
            $('#stop_containers').val('停止选定容器中.....')

        }else if(action_type=="start_containers") {
            var action = "start";
            var type = 'containers'
            var button_text = $('#start_containers').val();
            $('#start_containers').val('启动选定容器中.....')

        }else if (action_type == "remove_containers") {
            var action = "delete";
            var type = 'containers';
            var button_text = $('#remove_containers').val();
            $('#remove_containers').val('删除选定容器中.....')

        }else if(action_type == 'show_process'){
            var action = 'top';
            var type = 'containers';
            var button_text = $('#show_process').val();
            $('#show_process').val('获取进程信息中......')
        }else if(action_type == "exec_cmd"){
            var action = 'exec_cmd';
            var type = "containers";
            var cmd = $('#exec_cmd_input').val();
            var button_text = $('#exec_cmd').val();
            $('#show_exec_cmd_from').val('执行命令中......')
        }// end if

        var id_array = JSON.stringify(container_id_array);   // json化数据
        var default_body = '请勿狂点同一个提交按钮,<br><br>请求已提交后台处理,<br>处理完成后将会在每一行到末尾显示执行状态,&nbsp;请注意查看......';
        show_madel(default_body);

        $.ajax({   // 开始提交数据到后台去启动对应到容器
            url: '{% url 'docker_containers_manage' %}',
            type:'post',
            dataType:'json',
            token:csrftoken,
            data:{'container_id_array':id_array,'action':action,'type':type,'cmd':cmd},
            success:function(callback){
                if (action_type == 'show_process') {
                    show_container_process(callback);
                    $('#' + action_type).val(button_text);  // 把按钮原来的文本内容复位回去。
                }else {
                    show_exec_status('first_tr', callback);   //展示执行状态
                    $('#' + action_type).val(button_text); // 把按钮原来的文本内容复位回去。
                }
            }, //end success
            error: function(callback){
                console.log(callback)
            } // end error
        }); // end ajax
    }


    // 统计字典长度
    function len_of_dict(arg) {
        a = 0;
        for(var i in arg){
            if( arg[i] == undefined ){
                break
            }else{
                a=a+1
            }
        } // end for
        return a
    }

    // 搜索容器信息后也是通过这个方法来展现的
    function show_new_images(arg) {
            $('#exec_status').remove();
            $('.show_line').remove();
            var disconnect_hosts = arg.disconnect_hosts;
            if( disconnect_hosts != undefined ){
                for (var i in disconnect_hosts){
                    var html_code = '<tr class="show_line"><td><input type="checkbox"></td><td>服务器 <span style="color:red">'
                            +disconnect_hosts[i] +' </span>链接不上</td> </tr>';
                    $('#first_tr').after(html_code);
                }
            }
            for (var info in arg) {
                var image = arg[info];
                if (info != 'disconnect_hosts'){

                    var html_code = ' <tr class="show_line"><td><input host_port="'+ image.host_ip+'" type="checkbox" name="' + image.image_id + '" value="' + image.image_id + '"></td> ' +
                            '<td><a class="host_ip" href="/BatchM/DockerM.html/' + image.host_ip + '">' + image.host_ip + '&nbsp;</a></td> ' +
                            '<td><a href="/BatchM/DockerM.html/' + image.image_id + '"class="image_id">' + image.image_id.substr(0,13) + '</a></td>' +
                            '<td>' + image.Repo_tags + '</td>' +
                            '<td>' + image.Repo_digests + '</td>' +
                            //'<td>' + transformtime(image.Created) + '</td> ' +
                            '<td>' + image.Created + '</td> ' +
                            '<td>' + image.Image_size + '</td> ' +
                            '<td>' + image.Virtual_size + '</td> ' +
                            '<td>' + image.Labels + '</td>'+
                            '<td>' + image.update_time+'</td><tr>';
                    $('#second_tr').after(html_code);
                } // end if
            }
    }

    // 转换时间的，从unix时间到人肉眼可以识别的时间
    function transformtime(arg) {
        var unixtime = new Date(arg*1000);
        var unixtime = unixtime.toLocaleString();
        return unixtime

    }


    // 刷新镜像信息后通过这个方法展现
    function refresh_image_info(arg) {
        var mydate = new Date();
        success_list = arg.success;
        error_list = arg.error;
        $('#exec_status').remove();
        $('.show_line').remove();
        var succ_list = success_list[0];
        for(var image in succ_list){    // 遍历刷新成功的列表
            //console.log(succ_list[image]);
            //console.log(succ_list[image].Labels);
            console.log('image',image);
            console.log('succ_list',succ_list[image]);
            var image_list = succ_list[image]
            for (var per_image in image_list ){
                var html_code = ' <tr class="show_line"><td><input host_port="'+ image+'" type="checkbox" name="' + image_list[per_image].Id + '" value="' + image_list[per_image].Id + '"></td> ' +
                                '<td><a class="host_ip" href="/BatchM/DockerM.html/' + image + '">' + image + '&nbsp;</a></td> ' +
                                '<td><a href="/BatchM/DockerM.html/' + image_list[per_image].Id + '"class="image_id">' + image_list[per_image].Id.substr(0,13) + '</a></td>' +
                                '<td>' + image_list[per_image].RepoTags + '</td>' +
                                '<td>' + image_list[per_image].RepoDigests + '</td>' +
                                '<td>' + transformtime(image_list[per_image].Created) + '</td> ' +
                               // '<td>' + image_list[per_image].Created + '</td> ' +
                                '<td>' + image_list[per_image].Size + '</td> ' +
                                '<td>' + image_list[per_image].VirtualSize + '</td> ' +
                                '<td>' + [(succ_list[image].Labels == undefined) ?  " " :succ_list[image].Labels] + '</td>'+ // 添加上[]来包裹三元运算后前端展示就不会出问题
                                '<td>' + mydate.toLocaleString() +'</td><tr>';
                $('#second_tr').after(html_code);
            }
        }
        for(var err in error_list[0]){     // 遍历刷新失败的列表
           var html_code = '<tr class="show_line"><td><input type="checkbox"></td><td>服务器 <span style="color:red">'
                            +err +' </span>链接不上或者其他原因导致刷新失败，请检查次这台服务器</td> </tr>';
            $('#second_tr').after(html_code);
        }
    }

    //显示镜像,删除镜像，添加镜像的
    function manage_images(arg) {
        var action_type = $(arg).attr('id');
        if (action_type == 'ShowImages') {

            var action = 'select';
            var type = 'images';
            var hosts = 'all';
            var button_text = $('#ShowImages').val();
            $('#ShowImages').val('刷新中.....');

        }else if(action_type == 'delete_images') {

            var container_id_array = {};
            $.each($('.table input:checkbox:checked'),function(){   // 获取所有选中到的input 的标签
                container_id_array[($(this).val())] = $(this).attr('host_port')
            });
            var lenarray = len_of_dict(container_id_array);
            console.log(lenarray);
            if ( lenarray == 0){   // 判断是否选中来某一个容器
                return_body= "您没有选中一个镜像！！！<br>您没有选中一个镜像！！！<br>您没有选中一个镜像！！！重要事情说三遍";
                show_madel(return_body);
                return false
            }else{

                var action = 'delete';
                var type = 'images';
                var hosts = {};
                $.each($('.table input:checkbox:checked'),function () {
                    if(  hosts[$(this).attr('host_port')] ){  // 先判断有没有这个KEY,有的话再在后面追加镜像ID，没有的话，新添加镜像ID。
                         hosts[$(this).attr('host_port')].push($(this).val())
                    }else {
                        hosts[$(this).attr('host_port')] = [$(this).val()]
                    }
                });
                var button_text = $('#delete_images').val();
                $('#delete_images').val('删除中.....');
                hosts = JSON.stringify(hosts);
                console.log('hosts',hosts);
            }

        }else if(action_type == "add_image"){
            var action = 'push';
            var type = 'images';

            var button_text = $('#add_image').val();
            $('#add_image').val('添加中......')
        } // end if

        $.ajax({
            url:'{% url "docker_containers_manage" %}',
            type:'POST',
            dataType: 'json',
            token:csrftoken,
            data: {'action':action,'type':type,'hosts':hosts},
            success:function(callback){
                if(action=='select'){
                    refresh_image_info(callback);
                    $('#ShowImages').val(button_text);
                }else if (action=='delete'){
                    show_exec_status('second_tr',callback);
                    $('#delete_images').val(button_text);
                }else if(action=='push'){
                    show_new_images(callback);
                    $('#add_image').val(button_text)
                }
                $('#show_images').val(button_text)
            }, // end success
            error: function(callback) {
                alert('操作失败，请联系平台管理员!!')
            } // end error
        }); // end ajax
    }

    // 显示创建容器的更高级创建参数,使用delegate这种方式来绑定按钮的事件，是因为模态框里的内容是后来填充进去的，
    // 导致之前定义的onlick事件无法生效，所以采用这种方式绑定事件
    $('#myModal').delegate('#showMoreConfig', 'click', function () {
        if($(this).prop('checked')) {
            $('#myModal').find('#complex_config').show();
        } else {
            $('#myModal').find('#complex_config').hide();
        }
    });

    // 载创建容器信息的时候，显示模态框的内容
    function show_create_table() {
        var create_table = $('#create_container_div').html();
        var create_button = $('#create_container_button').html();
        $('#myModal').modal('toggle');
        $('.modal-body').html(create_table);
        $('.modal-footer').html(create_button);
    }


    // 获取填写创建容器信息的表格，然后提交到后台处理。
    // 使用$('#myModal').find()来查找内容，因为这个模态框里的内容是后来填充进去的，这样才能找到值。
    function create_container(arg) {
        var container_name =  $('#myModal').find('#name').val().trim();
        var create_info = {};
        if(container_name.length > 0 ){
            $.each($('#myModal').find('#create_container_form select'),function () {   // 遍历select标签，获取用户所选到的值
                create_info[$(this).attr('id')] =  $(this).val()
            });
           $.each($('#myModal').find('#create_container_form input:text'),function () {   // 遍历input是text类型的标签，获取用户所选到的值
               if($(this).attr('id').startsWith('cpu')){
                   create_info[$(this).attr('id')] = Number($(this).val())
               }else {
                   create_info[$(this).attr('id')] = $(this).val();
               }
           });
           $.each($('#myModal').find('#create_container_form input:radio:checked'),function () {   // 遍历input是radio类型的标签，获取用户所选到的值
               create_info[$(this).attr('id')] = $(this).val();

           });

            if($(arg).attr('id') == 'save_model'){
                create_info['action'] = 'save_model';
                var button_text = $(arg).text();
                $(arg).text('保存模板中.......')
            }else if($(arg).attr('id') == 'create_container' ){
                create_info['action'] = 'create_container';
                var button_text = $(arg).text();
                $(arg).text('创建容器中......')
            }

            create_info.dns = create_info.dns+',';    // 对输入一个DNS IP的话，在最后吗添加一个，方便后端处理
            console.log('create_info',create_info);
            var create_info_json = JSON.stringify(create_info);
            $.ajax({
                url:'{% url 'docker_containers_manage' %}',
                type:'GET',
                datatype:'json',
                token:csrftoken,
                data:{'create_info':create_info_json},
                success: function(callback) {
                    try {
                        alert('创建成功,容器ID：' + JSON.parse(callback).substring(0, 12));
                        console.log(callback);
                        fresh_all_containers();
                        $(arg).text(button_text);   // 把之前的按钮信息复位回去
                    }
                    catch(TypeError){
                        var error_dict = JSON.parse(callback);
                        for(var i in error_dict){
                            alert('创建失败,来自'+i+' 的报错信息如下:'+error_dict[i]);
                            console.log(error_dict[i])
                        }
                    } // end catch
                }, // end success
                error:function(callback){

                    console.log(JSON.parse(callback))
                }
            })
        }else{
            alert('输入信息不完整，容器名字必填');
            return false
        }
    }

    // 点击执行命令的按钮的时候，显示输入命令框
    function  show_entercmd_table() {
        var enter_cmd = $('#enter_cmd_div').html();
        var enter_cmd_button = $('#enter_cmd_button').html();
        $('#myModal').modal('toggle');
        $('.modal-body').html(enter_cmd);
        $('.modal-footer').html(enter_cmd_button);
    }

    </script>
{% endblock %}
