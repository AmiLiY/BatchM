{% extends 'index.html' %}
{% block btitle %}{{ title }}{% endblock %}
{% block page_content %}


<div class="modal fade " id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel2">注意</h4>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="agree_edit" style="display: none" onclick="agree_operation('agree_edit')">确定修改</button>
          <button type="button" class="btn btn-primary" id="agree_del" style="display: none" onclick="agree_operation('agree_del')">确定删除</button>
      </div>
    </div>
  </div>
</div>





<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">

<div id="asset_list">
    <div class="panel-body" >


{#        搜索#}
{#        <select name="select_opinon" id="select_opinon">#}
{#            <option value="id">资产ID</option>#}
{#            <option value="IDC">IDC机房</option>#}
{#            <option value="business">业务线</option>#}
{#            <option value="IP">管理IP</option>#}
{#            <option value="manufactory">制造商</option>#}
{#            <option value="cpu">CPU型号</option>#}
{#        </select>#}
{#        =#}
{#        <input type="text"  id="input_content"  placeholder="请输入关键字进行搜索">#}
{#        <input type="submit" class="btn btn-info" onclick="search_info()">#}

        <button class="btn btn-success" style="float: left" onclick="show_confirm('agree_edit')">修改选中的资产入库</button>
        <button class="btn btn-danger" style="float: left" onclick="show_confirm('agree_del')">删除选中的资产记录</button>
        <button class="btn btn-info" style="float: left;display: none" id="save_edit" onclick="save_edit('save')" >保存记录</button>
        <button class="btn btn-default" style="float: left;display: none" id="cancel_edit" onclick="save_edit('cancel')">取消保存</button>
        <table id="asset_list_table" class="display table  table-hover" data-toggle="table"
                data-url="{% url 'show_asset_in_table' %}"
                data-method="get"
                data-pagination="true"
                data-side-pagination="server"
                data-page-list="[10, 20, 50, 100, 200]"
                data-search="true" data-mobile-responsive="true" searchOnEnterKey="true"
                data-show-refresh="true" data-show-columns="true"
                data-show-toggle="true" data-page-size=20 data-unique-id="asset_id"
                data-sort-stable="true"  data-striped="true"
                data-sortable="true"
                >
              <thead >
                    <tr>
                    <th data-field="state" data-checkbox="true"></th>
                    <th data-field="asset_id" class="asset_id" data-align="center" data-sortable="true">资产ID(点击ID查看详情)</th>
                    <th data-field="asset_sn" data-align="center" data-sortable="true"  data-width="50px">资产编号</th>
                    <th data-field="asset_business_unit" data-sortable="true">产品线</th>
                    <th data-field="asset_name" data-align="center" data-sortable="true"  data-class="asset_name">资产名</th>
                    <th data-field="asset_management_ip" data-align="center" data-sortable="true"  data-class="asset_management_ip">管理IP</th>
                    <th data-field="asset_manufactory" data-sortable="true">厂商</th>
                    <th data-field="asset_type" data-sortable="true">类型</th>
                    <th data-field="asset_os_release" data-sortable="true">操作系统</th>
                    <th data-field="asset_salt_minion_id" data-sortable="true">saltminion_id</th>
                    <th data-field="asset_cpu_model" data-sortable="true">CPU型号</th>
                    <th data-field="asset_cpu_count" data-sortable="true">CPU个数</th>
                    <th data-field="asset_cpu_core_count" data-sortable="true">CPU总核数</th>
                    <th data-field="asset_rams_size" data-sortable="true">内存大小（MB）</th>
                    <th data-field="asset_localdisks_size" data-sortable="true">磁盘总空间（GB）</th>
                    <th data-field="asset_admin" >资产管理员</th>
                    <th data-field="asset_idc" data-sortable="true">机房名</th>
                    <th data-field="asset_trade_date" data-sortable="true">购买日期</th>
                    <th data-field="asset_create_date" data-sortable="true">创建日期</th>
                    </tr>
              </thead>
{#                <tbody>#}
{#                {% for info in assets %}#}
{#                    <tr>#}
{#                        <th><a href="/asset/asset_list/{{ info.id }}" target="_blank">{{ info.id }}</a></th>#}
{#                        <th>{{ info.asset_type }}</th>#}
{#                        <th>{{ info.name }}</th>#}
{#                        <th>{{ info.sn }}</th>#}
{#                        <th>{{ info.idc }}</th>#}
{#                        <th>{{ info.business_unit }}</th>#}
{#                        <th>{{ info.management_ip }}</th>#}
{#                        <th>{{ info.manufactory }}</th>#}
{#                        <th>{{ info.model }}</th>#}
{#                        <th>{{ info.cpu_model }}</th>#}
{#                        <th>{{ info.cpu_core_count }}</th>#}
{#                        <th>{{ info.ram_size }}</th>#}
{#                        <th>{{ info.disk_size }}</th>#}
{#                        <th><a href="shell/{{ info.id }} " target="_blank">Run Cmd</a></th>#}
{#                    </tr>#}
{#                {% endfor %}#}
{#                </tbody>#}
                <footer></footer>
        </table>
    </div>
</div>
<div id="asset_graphic" >
    <h4>当前批准入库服务器总数:&nbsp;&nbsp;<span id="total_number_show" style="color: red;font-size: larger"></span></h4>
    <div>
        <div id="os_release"  style="min-width:400px;height:450px;background-color:aliceblue;width: 50%;float: left"></div>
        <div id="manufactory"  style="min-width:400px;height:450px;background-color:aliceblue;width: 50%;float: right"></div>
        <!--暂未使用这个代码，后续可能使用 <div id="hosts_show" style="min-width:400px;height:450px"></div>
        <div>
            <h4>请选择月份</h4>
            <select>
                <option selected="selected">now</option>
                {% for month in months %}
                    <option>{{ month }}</option>
                {% endfor %}
            </select>
            <input type="submit" onclick="get_data('')">
        </div>
        --> -
        <div id="hosts_show" style="min-width:400px;height:450px">
    </div>
</div>


{% endblock %}
{% block encoding_js %}

    <script src="https://img.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <script src="https://img.hcharts.cn/highcharts/highcharts.js"></script>
    <script src="https://img.hcharts.cn/highcharts/modules/exporting.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

    <!-- Latest compiled and minified Locales -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>

    <script>
        $(document).ready( function () {    // 这个方法来用去高亮当前页面到右边选择到标签
            if ($('.page-header').text() == '服务器信息表') {
                $('#server_asset').toggleClass('active').siblings().removeClass('active');
                $('#sub-item-3').addClass('in').removeAttr('style');
                $('#server_list').css('background-color', 'grey');
                $('#asset_graphic').hide();
                $('#asset_list').show();

            } else if ($('.page-header').text() == '服务器信息饼状图') {
                $('#server_asset').toggleClass('active').siblings().removeClass('active');
                $('#sub-item-3').addClass('in').removeAttr('style');
                $('#server_graphic').css('background-color', 'grey');
                $('#asset_list').hide();
                $('#asset_graphic').show();
                get_data('os_release');
                get_data('manufactory');
                get_data('hosts_show')
            }
        });


    function create_graphic(result,data_type) {
        if(data_type == 'os_release'){   // 显示系统版本的圆饼图
            var os_release_data = [];
            for(var i in result){
                var push_data = [i,Number(result[i])];
                os_release_data.push(push_data);
            }
            $('#os_release').highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: '服务器操作系统图'
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                }
            },
            series: [{
                type: 'pie',
                name: 'system  version',

                data:os_release_data,
            }]
        });  // end if

        }else if(data_type == 'manufactory'){   // 显示服务器制造商的图
            var manufactory_data = [];
            for(var i in result){
                manufactory_data.push([i,result[i]])
            }
            $('#manufactory').highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: '服务器制造商'
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                }
            },
            series: [{
                type: 'pie',
                name: 'manufactory',
                data: manufactory_data,
            }]
        }); // end else if

        }else if(data_type='hosts_show') {   // 折线图
            if(result['approved_month'].length  == 0){
                result['approved_month']=result['approve_month']
            }

            $('#hosts_show').highcharts({
                chart: {
                    type: 'line'
                },
                title: {
                    text: '服务器入库信息'
                },
                subtitle: {
                    text: '最近一个月变动信息'
                },
                xAxis: {
                    categories: result['approved_month']
                },
                yAxis: {
                    title: {
                        text: '数量'
                    }
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        },
                        enableMouseTracking: false
                    }
                },
                series: [{
                    name: '已批准的服务器',
                    data: result['approved_number']
                }, {
                    name: '待批准的服务器',
                    data: result['approve_number']
                }]
            });
        }

    };

    // getting data to paint for hcharts from server
    function get_data(arg) {
        $.ajax(
            {
                url:'/asset/asset_graphic',
                type:'POST',
                token:csrftoken,
                dataType:'json',
                data:{'graphic_type':arg},
                success: function(data) {
                    console.log(data);
                    if(arg == 'hosts_show'){
                        var result = handler_data_line_chart(data, arg);
                        console.log('result',result);
                        create_graphic(result,arg)
                    }else {
                        var result = handler_data_pie_chart(data, arg);
                        create_graphic(result, arg)
                    }

                 }, // end success
                error: function (data) {
                    console.log(data)
                }, // end error
            }
        )
    }

    // handler these data from response of server,the data is  create a pie chart
    function handler_data_pie_chart(data,data_type) {
        var os_release_dict = {};
        var total_number = data.total_number;
        var os_release_number = data.os_release_number;
        for(var i in os_release_number){
            os_release_dict[i]=os_release_number[i]/total_number*100
        }
        if(data_type=='os_release') {
            $('#total_number_show').text(total_number)
        }
        return os_release_dict
    }

    // handler these data from response of server,the data is  create a line chart
    function  handler_data_line_chart(data,data_type) {
        var already_approved = data.already_approved;
        var wating_approve = data.waiting_approve;

        var approved_month = [];   // the list was storadged  month what come from    already_approved dict
        var approved_number = [];  // the list was storadged  how many asset was approved
        for(var k in already_approved){
            approved_month.push(k);
            approved_number.push(already_approved[k])
        }

        var approve_month = [];
        var approve_number = [];
        for(var k in wating_approve){
            approve_month.push(k);
            approve_number.push(wating_approve[k]);
        }

        var result = {};
        result['approved_month'] =  approved_month;
        result['approved_number'] = approved_number;
        result['approve_month'] = approve_month;
        result['approve_number'] = approve_number;
        return result
    }

    // 处理搜索的功能
    function search_info() {
        var select_opinon = $('#select_opinon').val();
        var input_content = $('#input_content').val();
        console.log(select_opinon,input_content);
        $.ajax({
                    url: '/asset/asset_graphic',
                    token: csrftoken,
                    dataTypes: 'json',
                    type:'get',
                    data: {'select_opinon':select_opinon,'input_content':input_content},
                    success: function (callback) {
                        console.log('success',callback)
                    },
                    error: function (callback) {
                        console.log('error',callback)
                    }
              })
    }

    // 出现模特框，让用户再次确认当前操作。
    function show_confirm(arg) {  // 显示模态框，在批准入库和删除记录之前弹出来再次确认
            var asset_id = [];
            $('input:checkbox:checked').parent().siblings('.asset_id').each(function () {   // 遍历所有选中的框来
                    asset_id.push(Number($(this).text()))
                });
            if ( asset_id.length == 0 ){
                alert('没有选中任何数据');
                return false
            }

            $('#myModal').modal('toggle');   // 打开模态框
            $("#"+arg).show().siblings('.btn-primary').hide();
            if(arg=='agree_del'){
                $('.modal-body').html("确定要删除所选记录")
            }else if(arg=='agree_edit') {
                $('.modal-body').html("确定修改所选记录入库")
            }
        }

        // 对选中的资产信息进行编辑
    function  edit_table(data) {
        $('#save_edit,#cancel_edit').show();  // show buttons

        var original_data = {};
        for(var d in data){
            d = data[d];
            console.log(d);
            original_data[d] = [];
            $('input:checkbox:checked').parent().siblings('.asset_id').each(function () {   // 遍历所有选中的框来
                if( d == Number($(this).text())){
                    $.each($(this).siblings('td'),function () {
                        original_data[d].push($(this).text());
                        $(this).replaceWith("<td><input type='text' class='d '"+$(this).text()+"' value='"+ $(this).text() +"'>")
                    })
                } // end if
            });
        } // end for
        console.log(original_data);
    }



    //  删除选中的  数据和修改数据的
    function  agree_operation(arg) {
        $('#myModal').modal('toggle');
        var asset_id = [];
        $('input:checkbox:checked').parent().siblings('.asset_id').each(function () {   // 遍历所有选中的框来
                asset_id.push(Number($(this).text()))
            });
        if ( asset_id.length == 0 ){
            alert('没有选中任何数据');
            return false
        }
        console.log(arg,asset_id);
         if(arg=='agree_edit'){
            result = edit_table(asset_id)
        }
         var asset_id = JSON.stringify(asset_id);
         var csrftoken = getCookie('csrftoken');
        $.ajax({
            url:"{% url 'asset_operation' %}",
            dataType:"json",
            token : csrftoken,
            type:'get',
            data:{},
            success: function () {

            }, // end success
            error:function () {

            }, // end error
        })
    }

    // 编辑表格的时候，通过这个方法来保存对应的内容
    function  save_edit(arg) {

    }




    </script>
{% endblock %}